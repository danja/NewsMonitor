<!doctype html>
<html lang="en">
<head>
   <meta charset="utf-8">
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Feeds</title>
<!-- link rel="stylesheet" href="css/jquery.ui.all.css" -->
<link rel="stylesheet" href="css/themes/base/jquery.ui.all.css">
<!--   link rel="stylesheet" href="css/jquery.ui.accordian.css" -->
   <link rel="stylesheet" href="css/common.css">
	<!--  link rel="stylesheet" href="css/river.css" -->
<script type="text/javascript" src="/js/jquery-1.10.2.js"></script>
<script type="text/javascript" language="javascript">

	var sparqlEndpoint = "http://localhost:3030/feedreader/query?query=";
	
	var sparql = "PREFIX rss: <http://purl.org/rss/1.0/>\
PREFIX dcterms: <http://purl.org/dc/terms/>\
PREFIX foaf: <http://xmlns.com/foaf/0.1/> \
PREFIX schema: <http://schema.org/> \
PREFIX nm: <http://purl.org/stuff/newsmonitor/> \
\
SELECT DISTINCT ?feedTitle ?feedHtml ?feedUrl ?entry ?title ?content ?date ?author ?authorHomepage \
WHERE { \
\
GRAPH ?g { \
   ?entry a schema:article . \
      OPTIONAL { \
         ?feedUrl dcterms:title ?feedTitle . \
         ?entry dcterms:source ?feedUrl . \
      } \
      OPTIONAL { \
         ?source nm:htmlUrl ?feedHtml . \
         ?entry dcterms:source ?feedUrl . \
      } \
      OPTIONAL { ?entry dcterms:title ?title . } \
      OPTIONAL { ?entry dcterms:date ?date . } \
      OPTIONAL { ?entry schema:articleBody ?content . } \
      OPTIONAL { ?entry dcterms:creator [foaf:name ?author] . } \
      OPTIONAL { ?entry dcterms:creator [foaf:homepage ?authorHomepage] . } \
      # admin \
      OPTIONAL { ?entry nm:relevance ?relevance . } \
      OPTIONAL { ?entry nm:favourite ?favourite . } \
      OPTIONAL { ?entry nm:read ?read . } \
   }\
} \
ORDER BY DESC(?date) \
# LIMIT 10 \
OFFSET 0 \
";

var url = sparqlEndpoint+ encodeURIComponent(sparql) + "&output=xml";
	
$(function() {
	var $loading = $('#spinner').hide();
	$("#accordion-resizer").hide();
	jQuery.ajaxSetup({
		  beforeSend: function() {
		     $('#spinner').show();
		     
		  },
		  complete: function(){
		     $('#spinner').hide();
		     $("#accordion-resizer").show();
		  },
		  success: function() {}
		});
   getEntries();
});
	
	
	function getEntries() {
	//	$.get(url, function(xml) {
			$.ajax({
				url: url, 
				accept: {
						  xml: 'application/xml;charset=UTF-8',
						  sparql: 'sparql-results+xml;charset=UTF-8'
						  },
				headers: { // belt and braces
						        'Accept':'sparql-results+xml;charset=UTF-8'
						     //   'Accept-Charset': 'UTF-8' unsafe
						        }
				
			}).done(function(xml) {
		
			var xmlString = (new XMLSerializer()).serializeToString(xml);

			// workaround for wrong interpretation of charset
			xmlString = xmlString.replace(/[^\u0000-\u007F]/g, '');
			// maybe force to ISO-8859-1, also known as Latin-1 instead?
	
				var $xml = $(xmlString);

				$xml.find("result").each(function() {
					// $('#results').html($(this));
					var entryUrl, source, title, content, date, author, authorHomepage;
					
					$(this).find("binding[name='entry']").each(function() {
						entryUrl = $(this).text().trim();
					});
					$(this).find("binding[name='source']").each(function() {
						source = $(this).text().trim();
					});
					$(this).find("binding[name='title']").each(function() {
						title = $(this).text().trim();
					});
					$(this).find("binding[name='content']").each(function() {
						content = $(this).text().trim();
					});
					$(this).find("binding[name='date']").each(function() {
						date = $(this).text().trim();
					});
					$(this).find("binding[name='author']").each(function() {
						author = $(this).text().trim();
					});
					$(this).find("binding[name='authorHomepage']").each(function() {
						authorHomepage = $(this).text().trim();
					});
					var entry = generateEntryHtml(entryUrl, source, title, content, date, author, authorHomepage);
					$("#accordion").append(entry);
				});
				doAccordion();
			});
	}
	
	function generateEntryHtml(entryUrl, source, title, content, date, author, authorHomepage) {
		var entry = "<h3 >";
		
		if(author != null && authorHomepage == null) {
			entry += "<div class=\"author\">" + author + "</div> : ";
		}
		if(author != null && authorHomepage != null) {
			entry += "<div class=\"author\"><a href=\"" + authorHomepage+ "\">"+ author + "</a></div> :";
		}
		entry += "<a href=\""+entryUrl+"\">" + title + "</a></h3>";
		entry += "<div>";
		
		entry += "<div class=\"content\">"+content+"</div>";

		entry += "<div class=\"updated\">" + date + "</div>";
		
		entry += "</div>"
		return entry;
	}
	
	function doAccordion(){
		$( "#accordion" ).accordion({
			heightStyle: "fill"
		});
		$("#accordion-resizer").resizable({
			minHeight: 140,
			minWidth: 200,
			resize: function() {
				$( "#accordion" ).accordion( "refresh" );
			}
	});
		$("#accordion").accordion({collapsible:true});
		$("#accordion").accordion({active:false});
		$("#accordion-resizer").width(800);
	}
	</script>


<!--   script type="text/javascript" src="/js/jquery-ui-1.10.4.min.js"></script -->

   <script src="/js/ui/jquery.ui.core.js"></script>
   <script src="/js/ui/jquery.ui.widget.js"></script>
   <script src="/js/ui/jquery.ui.mouse.js"></script>
   <script src="/js/ui/jquery.ui.resizable.js"></script>
   <script src="/js/ui/jquery.ui.accordion.js"></script>
   <script>	
	// function doAccordian(){

	//}
</script>
</head>
<body>
 
	<h1>Entries</h1>
	<p>
		<a href="/index.html">Home</a>
	</p>

 <div id="spinner" class="spinner"></div> <!--   img src="/css/spinner.gif" / -->  
 
<div id="accordion-resizer" class="ui-widget-content">

	<div id="accordion">
   </div>

   </div>
  
</body>
</html>