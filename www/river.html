<!doctype html>
<html lang="en">
<head>
   <meta charset="utf-8">
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Feeds</title>
<!-- link rel="stylesheet" href="css/jquery.ui.all.css" -->
<link rel="stylesheet" href="css/themes/base/jquery.ui.all.css">
<!--   link rel="stylesheet" href="css/jquery.ui.accordian.css" -->
	<!--  link rel="stylesheet" href="css/river.css" -->
<script type="text/javascript" src="/js/jquery-1.10.2.js"></script>
<script type="text/javascript" language="javascript">

	var sparqlEndpoint = "http://localhost:3030/feedreader/query?query=";
	
	var sparql = "PREFIX rss: <http://purl.org/rss/1.0/>\
PREFIX dcterms: <http://purl.org/dc/terms/>\
PREFIX foaf: <http://xmlns.com/foaf/0.1/> \
PREFIX schema: <http://schema.org/> \
PREFIX nm: <http://purl.org/stuff/newsmonitor/> \
\
SELECT DISTINCT ?feedTitle ?feedHtml ?feedUrl ?entry ?title ?content ?date ?author ?authorHomepage \
WHERE { \
\
GRAPH ?g { \
   ?entry a schema:article . \
      OPTIONAL { \
         ?feedUrl dcterms:title ?feedTitle . \
         ?entry dcterms:source ?feedUrl . \
      } \
      OPTIONAL { \
         ?source nm:htmlUrl ?feedHtml . \
         ?entry dcterms:source ?feedUrl . \
      } \
      OPTIONAL { ?entry dcterms:title ?title . } \
      OPTIONAL { ?entry dcterms:date ?date . } \
      OPTIONAL { ?entry schema:articleBody ?content . } \
      OPTIONAL { ?entry dcterms:creator [foaf:name ?author] . } \
      OPTIONAL { ?entry dcterms:creator [foaf:homepage ?authorHomepage] . } \
   }\
} \
ORDER BY DESC(?date)";

// console.log("SPARQL="+sparql);
// console.log("SPARQL escaped="+escape(sparql));

var url = sparqlEndpoint+ encodeURIComponent(sparql) + "&output=xml";
//	var url = "http://localhost:3030/feedreader/query?query=PREFIX+rss%3A+%3Chttp%3A%2F%2Fpurl.org%2Frss%2F1.0%2F%3E+%0D%0APREFIX+dcterms%3A%3Chttp%3A%2F%2Fpurl.org%2Fdc%2Fterms%2F%3E%0D%0APREFIX+foaf%3A%3Chttp%3A%2F%2Fxmlns.com%2Ffoaf%2F0.1%2F%3E%0D%0APREFIX+schema%3A%3Chttp%3A%2F%2Fschema.org%2F%3E%0D%0APREFIX+nm%3A+%3Chttp%3A%2F%2Fpurl.org%2Fstuff%2Fnewsmonitor%2F%3E%0D%0A%0D%0ASELECT+DISTINCT+%3FfeedTitle+%3FfeedHtml+%3FfeedUrl+%3FfeedAuthor+%3Fentry+%3Ftitle+%3Fcontent+%3Fupdated+%3Fauthor+%3FauthorHomepage+%0D%0AWHERE+%7B+%0D%0A%0D%0AGRAPH+%3Fg+%7B%0D%0A+++%3Fentry+a+schema%3Aarticle+.%0D%0A++++++OPTIONAL+%7B+%0D%0A+++++++++%3FfeedUrl+dcterms%3Atitle+%3FfeedTitle+.+%0D%0A+++++++++%3Fentry+dcterms%3Asource+%3FfeedUrl+.%0D%0A++++++%7D%0D%0A++++++OPTIONAL+%7B+%0D%0A+++++++++%3Fsource+nm%3AhtmlUrl+%3FfeedHtml+.+%0D%0A+++++++++%3Fentry+dcterms%3Asource+%3FfeedUrl+.%0D%0A++++++%7D%0D%0A++++++OPTIONAL+%7B+%0D%0A+++++++++%3Fsource+dcterms%3Acreator+%5Bfoaf%3Aname+%3FfeedAuthor%5D+.+%0D%0A+++++++++%3Fentry+dcterms%3Asource+%3FfeedUrl+.%0D%0A++++++%7D%0D%0A++++++OPTIONAL+%7B+%3Fentry+dcterms%3Atitle+%3Ftitle+.+%7D%0D%0A++++++OPTIONAL+%7B+%3Fentry+dcterms%3Aupdated+%3Fupdated+.+%7D%0D%0A++++++OPTIONAL+%7B+%3Fentry+schema%3AarticleBody+%3Fcontent+.+%7D%0D%0A++++++OPTIONAL+%7B+%3Fentry+dcterms%3Acreator+%5Bfoaf%3Aname+%3Fauthor%5D+.+%7D%0D%0A++++++OPTIONAL+%7B+%3Fentry+dcterms%3Acreator+%5Bfoaf%3Ahomepage+%3FauthorHomepage%5D+.+%7D%0D%0A+++%7D%0D%0A%7D%0D%0AORDER+BY+DESC%28%3Fupdated%29&output=xml";

	
	
		$(function() {
  getEntries();
// doAccordion();
// $( "#accordion" ).accordion({collapsible:true});
// $("#accordion-resizer").width(800);
	});
	
	
	function getEntries() {
	//	$.get(url, function(xml) {
			$.ajax({
				url: url, 
				accept: {
						  xml: 'application/xml;charset=UTF-8',
						  sparql: 'sparql-results+xml;charset=UTF-8'
						  },
				headers: { // belt and braces
						        'Accept':'sparql-results+xml;charset=UTF-8',
						        'Accept-Charset': 'UTF-8'
						        }
				
			}).done(function(xml) {
			
			//	alert("Load was performed.");
		
			var xmlString = (new XMLSerializer()).serializeToString(xml);
			//console.log(xmlString);
			//console.log("----------------------------------------------------");
			
			//  0xEF 0xBF 0xBD
		xmlString = encode_utf8(xmlString);
		//	xmlString = xmlString.replace("\xef\xbf\xbd", " ");
		//	xmlString = native2ascii(xmlString);
	//	xmlString = xmlString.replace("/\uFFFD/g", " ");
	
	// workaround for wrong interpretation of charset
	xmlString = xmlString.replace(/[^\u0000-\u007F]/g, '');
	// maybe force to ISO-8859-1, also known as Latin-1 instead?
	
	//	xmlString = xmlString.replace("ï¿½", " ");
			//	xml = decode_utf8(xml);
				
			//	console.log(xml);
				var $xml = $(xmlString);
				
//				var html = "<div id=\"accordion-resizer\" class=\"ui-widget-content\">";
//				html += "<div id=\"accordion\">"; 
				$xml.find("result").each(function() {
					// $('#results').html($(this));
					var entryUrl, source, title, content, updated, author, authorHomepage;
					// console.log("result = " + $(this));
					
					$(this).find("binding[name='entry']").each(function() {
						//   	$("#results").append($(this).text());
						entryUrl = $(this).text();
					});
					var feedUrl, title, updated, author, authorHomepage;
					$(this).find("binding[name='source']").each(function() {
						//	$("#results").append($(this).text());
						source = $(this).text();
					});
					$(this).find("binding[name='title']").each(function() {
						//   	$("#results").append($(this).text());
						title = $(this).text();
					});
					$(this).find("binding[name='content']").each(function() {
						//   	$("#results").append($(this).text());
						content = $(this).text();
						// content = "guff";
					});
					$(this).find("binding[name='updated']").each(function() {
						//$("#results").append($(this).text());
						updated = $(this).text();
					});
					$(this).find("binding[name='author']").each(function() {
						//$("#results").append($(this).text());
						author = $(this).text();
					});
					$(this).find("binding[name='authorHomepage']").each(function() {
						//$("#results").append($(this).text());
						authorHomepage = $(this).text();
					});
					var entry = generateEntryHtml(entryUrl, source, title, content, updated, author, authorHomepage);
					// $("#results").append(entry);
					$("#accordion").append(entry);
					// html += entry;
				});
				//html += "</div></div>";
				//$("#accordion").append(html);
				doAccordion();
			});
	}

	function native2ascii(str) {
		var out = "";
		for (var i = 0; i < str.length; i++) {
			if (str.charCodeAt(i) < 0x80) {
				out += str.charAt(i);
			} else {
				var u = "" + str.charCodeAt(i).toString(16);
				out += "\\u" + (u.length === 2 ? "00" + u : u.length === 3 ? "0" + u : u);
			}
		}
		return out;
	}
	
	function encode_utf8(s) {
		  return unescape(encodeURIComponent(s));
		}

//	function decode(s) {
//		  return unescape(escape(s));
//		}
	
	function decode_utf8(s) {
		var e = escape(s);
		  return decodeURIComponent(e);
		}
	
	function doAccordion(){
		$( "#accordion" ).accordion({
			heightStyle: "fill"
		});
		$("#accordion-resizer").resizable({
			minHeight: 140,
			minWidth: 200,
			resize: function() {
				$( "#accordion" ).accordion( "refresh" );
			}
	});
		$("#accordion").accordion({collapsible:true});
		$("#accordion").accordion({active:false});
		$("#accordion-resizer").width(800);
	}
	
	function generateEntryHtml(entryUrl, source, title, content, updated, author, authorHomepage) {
		var entry = "<h3 >";
		
		if(author != null && authorHomepage == null) {
			entry += "<div class=\"author\">" + author + "</div> : ";
		}
		if(author != null && authorHomepage != null) {
			entry += "<div class=\"author\"><a href=\"" + authorHomepage+ "\">"+ author + "</a></div> :";
		}
		entry += "<a href=\""+entryUrl+"\">" + title + "</a></h3>";
		entry += "<div>";
		
		entry += "<div class=\"content\">"+content+"</div>";

		entry += "<div class=\"updated\">" + updated + "</div>";
		
		entry += "</div>"
		return entry;
	}
	</script>


<!--   script type="text/javascript" src="/js/jquery-ui-1.10.4.min.js"></script -->

   <script src="/js/ui/jquery.ui.core.js"></script>
   <script src="/js/ui/jquery.ui.widget.js"></script>
   <script src="/js/ui/jquery.ui.mouse.js"></script>
   <script src="/js/ui/jquery.ui.resizable.js"></script>
   <script src="/js/ui/jquery.ui.accordion.js"></script>
   <script>	
	// function doAccordian(){

	//}
</script>
</head>
<body>
	<h1>Feeds</h1>
	<p>
		<a href="/index.html">Home</a>
	</p>
   <h3 class="docs">Resize the outer container:</h3>

<div id="accordion-resizer" class="ui-widget-content">
	<div id="accordion">
   </div>
   </div>
   <!-- div id="results"></div -->
  
	
   
</body>
</html>